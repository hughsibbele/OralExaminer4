<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Source+Sans+Pro:wght@400;600&display=swap" rel="stylesheet">
    <style>
      * {
        box-sizing: border-box;
      }

      :root {
        --cream: #FAF6F0;
        --cream-dark: #F0E9DF;
        --burgundy: #722F37;
        --burgundy-dark: #5C252C;
        --burgundy-light: #8B3A44;
        --terracotta: #B85C38;
        --terracotta-dark: #8B3A2F;
        --forest: #4A6741;
        --forest-light: #5C7A52;
        --wheat: #D4A84B;
        --wheat-light: #E8C777;
        --gold: #C9A227;
        --gold-light: #E5C55A;
        --brown-dark: #3D2914;
        --brown: #5C4332;
        --blue-muted: #7BA3B5;
        --red-error: #C44536;
      }

      body {
        font-family: 'Source Sans Pro', -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--cream);
        background-image:
          radial-gradient(circle at 20% 80%, rgba(114, 47, 55, 0.05) 0%, transparent 50%),
          radial-gradient(circle at 80% 20%, rgba(201, 162, 39, 0.05) 0%, transparent 50%);
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .container {
        background: white;
        border-radius: 12px;
        box-shadow:
          0 4px 6px rgba(61, 41, 20, 0.07),
          0 12px 28px rgba(61, 41, 20, 0.12);
        width: 100%;
        max-width: 600px;
        overflow: hidden;
        border: 1px solid rgba(212, 168, 75, 0.3);
      }

      /* Folk Art Border Pattern */
      .header {
        background: linear-gradient(135deg, var(--burgundy) 0%, var(--burgundy-dark) 100%);
        color: white;
        padding: 28px 36px;
        text-align: center;
        position: relative;
      }

      .header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 6px;
        background: repeating-linear-gradient(
          90deg,
          var(--gold) 0px,
          var(--gold) 12px,
          var(--burgundy-dark) 12px,
          var(--burgundy-dark) 24px,
          var(--wheat) 24px,
          var(--wheat) 36px,
          var(--burgundy-dark) 36px,
          var(--burgundy-dark) 48px
        );
      }

      .header h1 {
        margin: 0 0 6px 0;
        font-family: 'Merriweather', Georgia, serif;
        font-size: 1.5rem;
        font-weight: 700;
        letter-spacing: 0.5px;
      }

      .header p {
        margin: 0;
        opacity: 0.9;
        font-size: 0.9rem;
        font-weight: 400;
      }

      .content {
        padding: 32px 36px;
      }

      /* Screen States */
      .screen {
        display: none;
      }

      .screen.active {
        display: block;
      }

      /* ==================== */
      /* WELCOME SCREEN       */
      /* ==================== */

      .welcome-content {
        text-align: center;
        padding: 20px 0;
      }

      .avatar-large {
        width: 160px;
        height: 160px;
        border-radius: 50%;
        object-fit: cover;
        border: 5px solid var(--gold);
        box-shadow:
          0 0 0 3px var(--burgundy),
          0 8px 32px rgba(114, 47, 55, 0.25);
        margin-bottom: 24px;
      }

      .welcome-title {
        font-family: 'Merriweather', Georgia, serif;
        font-size: 1.75rem;
        color: var(--burgundy);
        margin: 0 0 16px 0;
        font-weight: 700;
      }

      .welcome-intro {
        color: var(--brown);
        line-height: 1.7;
        font-size: 1rem;
        margin: 0 0 24px 0;
        font-style: italic;
      }

      .ornamental-divider {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin: 24px 0;
        color: var(--gold);
      }

      .ornament-line {
        height: 2px;
        width: 60px;
        background: linear-gradient(90deg, transparent, var(--gold), transparent);
      }

      .ornament-diamond {
        width: 8px;
        height: 8px;
        background: var(--gold);
        transform: rotate(45deg);
      }

      /* ==================== */
      /* FORM STYLES          */
      /* ==================== */

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--brown-dark);
        margin-bottom: 8px;
        font-family: 'Merriweather', Georgia, serif;
      }

      input[type="text"] {
        width: 100%;
        padding: 12px 14px;
        border: 2px solid var(--cream-dark);
        border-radius: 8px;
        font-size: 1rem;
        font-family: inherit;
        transition: all 0.2s ease;
        background: var(--cream);
      }

      input[type="text"]:focus {
        outline: none;
        border-color: var(--burgundy);
        background: white;
        box-shadow: 0 0 0 3px rgba(114, 47, 55, 0.1);
      }

      textarea {
        width: 100%;
        padding: 12px 14px;
        border: 2px solid var(--cream-dark);
        border-radius: 8px;
        font-size: 0.95rem;
        font-family: inherit;
        line-height: 1.6;
        resize: vertical;
        min-height: 180px;
        transition: all 0.2s ease;
        background: var(--cream);
      }

      textarea:focus {
        outline: none;
        border-color: var(--burgundy);
        background: white;
        box-shadow: 0 0 0 3px rgba(114, 47, 55, 0.1);
      }

      .char-count {
        display: flex;
        justify-content: flex-end;
        margin-top: 6px;
        font-size: 0.8rem;
        color: var(--brown);
      }

      .char-count.warning {
        color: var(--wheat);
      }

      .char-count.error {
        color: var(--red-error);
        font-weight: 600;
      }

      /* ==================== */
      /* BUTTON STYLES        */
      /* ==================== */

      .btn {
        width: 100%;
        padding: 14px 24px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        font-family: inherit;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--burgundy) 0%, var(--burgundy-dark) 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(114, 47, 55, 0.3);
      }

      .btn-primary:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(114, 47, 55, 0.4);
      }

      .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .btn-success {
        background: linear-gradient(135deg, var(--forest) 0%, var(--forest-light) 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(74, 103, 65, 0.3);
      }

      .btn-success:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(74, 103, 65, 0.4);
      }

      .btn-secondary {
        background: var(--cream);
        color: var(--brown-dark);
        border: 2px solid var(--cream-dark);
      }

      .btn-secondary:hover {
        background: var(--cream-dark);
      }

      /* Spinner */
      .spinner {
        width: 18px;
        height: 18px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* ==================== */
      /* READY SCREEN         */
      /* ==================== */

      .ready-content {
        text-align: center;
      }

      .avatar-medium {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid var(--gold);
        box-shadow: 0 4px 16px rgba(114, 47, 55, 0.2);
        margin-bottom: 20px;
      }

      .summary-card {
        background: var(--cream);
        border: 2px solid var(--cream-dark);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 24px;
        text-align: left;
      }

      .summary-card h3 {
        font-family: 'Merriweather', Georgia, serif;
        font-size: 1rem;
        color: var(--burgundy);
        margin: 0 0 12px 0;
      }

      .summary-item {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        margin-bottom: 10px;
        font-size: 0.9rem;
      }

      .summary-item:last-child {
        margin-bottom: 0;
      }

      .summary-label {
        color: var(--brown);
        min-width: 80px;
        font-weight: 600;
      }

      .summary-value {
        color: var(--brown-dark);
        flex: 1;
      }

      .essay-preview {
        background: white;
        padding: 10px;
        border-radius: 6px;
        font-size: 0.85rem;
        color: var(--brown);
        font-style: italic;
        max-height: 60px;
        overflow: hidden;
        position: relative;
      }

      .essay-preview::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 30px;
        background: linear-gradient(transparent, white);
      }

      .speech-bubble {
        background: var(--cream);
        border: 2px solid var(--gold);
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 24px;
        position: relative;
        font-style: italic;
        color: var(--brown);
        line-height: 1.6;
      }

      .speech-bubble::before {
        content: '';
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-bottom: 10px solid var(--gold);
      }

      .speech-bubble::after {
        content: '';
        position: absolute;
        top: -7px;
        left: 50%;
        transform: translateX(-50%);
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-bottom: 8px solid var(--cream);
      }

      .checklist {
        background: var(--cream);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
        text-align: left;
      }

      .checklist-title {
        font-family: 'Merriweather', Georgia, serif;
        font-size: 0.9rem;
        color: var(--brown-dark);
        margin: 0 0 12px 0;
        font-weight: 600;
      }

      .checklist-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
        font-size: 0.9rem;
        color: var(--brown);
      }

      .checklist-item:last-child {
        margin-bottom: 0;
      }

      .check-icon {
        width: 20px;
        height: 20px;
        background: var(--forest);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .check-icon svg {
        width: 12px;
        height: 12px;
        color: white;
      }

      /* ==================== */
      /* DEFENSE SCREEN       */
      /* ==================== */

      .defense-content {
        text-align: center;
      }

      .agent-avatar-wrapper {
        position: relative;
        width: 140px;
        height: 140px;
        margin: 0 auto 20px;
      }

      .agent-avatar {
        width: 140px;
        height: 140px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid var(--gold);
        box-shadow: 0 4px 20px rgba(201, 162, 39, 0.3);
        transition: box-shadow 0.3s ease;
      }

      .agent-avatar.speaking {
        box-shadow:
          0 0 0 8px rgba(201, 162, 39, 0.2),
          0 0 0 16px rgba(201, 162, 39, 0.1),
          0 4px 20px rgba(201, 162, 39, 0.3);
        animation: pulse-glow 1.5s ease-in-out infinite;
      }

      @keyframes pulse-glow {
        0%, 100% {
          box-shadow:
            0 0 0 8px rgba(201, 162, 39, 0.2),
            0 0 0 16px rgba(201, 162, 39, 0.1),
            0 4px 20px rgba(201, 162, 39, 0.3);
        }
        50% {
          box-shadow:
            0 0 0 12px rgba(201, 162, 39, 0.15),
            0 0 0 24px rgba(201, 162, 39, 0.05),
            0 4px 20px rgba(201, 162, 39, 0.3);
        }
      }

      .defense-header h2 {
        font-family: 'Merriweather', Georgia, serif;
        font-size: 1.25rem;
        color: var(--brown-dark);
        margin: 0 0 8px 0;
      }

      .defense-header p {
        color: var(--brown);
        margin: 0 0 20px 0;
        font-size: 0.9rem;
      }

      .call-timer {
        font-family: 'Merriweather', Georgia, serif;
        font-size: 1.1rem;
        color: var(--brown);
        margin-bottom: 16px;
      }

      .widget-container {
        background: var(--cream);
        border-radius: 12px;
        padding: 20px;
        min-height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid var(--cream-dark);
      }

      .widget-container.loading {
        color: var(--brown);
        font-size: 0.9rem;
      }

      /* Folk border frame around defense area */
      .defense-frame {
        border: 3px solid var(--gold);
        border-radius: 16px;
        padding: 24px;
        background: linear-gradient(white, white) padding-box,
                    repeating-linear-gradient(
                      45deg,
                      var(--gold) 0,
                      var(--gold) 5px,
                      var(--wheat-light) 5px,
                      var(--wheat-light) 10px
                    ) border-box;
      }

      /* Widget and Call Ended */
      .widget-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 24px 0;
        min-height: 60px;
      }

      .call-ended-message {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        color: var(--forest);
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 8px;
      }

      /* ==================== */
      /* COMPLETE SCREEN      */
      /* ==================== */

      .complete-content {
        text-align: center;
        padding: 20px 0;
      }

      .complete-icon {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, var(--forest) 0%, var(--forest-light) 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        box-shadow: 0 4px 16px rgba(74, 103, 65, 0.3);
      }

      .complete-icon svg {
        width: 40px;
        height: 40px;
        color: white;
      }

      .complete-content h2 {
        font-family: 'Merriweather', Georgia, serif;
        color: var(--brown-dark);
        font-size: 1.5rem;
        margin: 0 0 12px 0;
        font-weight: 700;
      }

      .complete-content p {
        color: var(--brown);
        line-height: 1.6;
        margin: 0 0 8px 0;
      }

      .student-name-display {
        display: inline-block;
        background: var(--cream);
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 600;
        color: var(--brown-dark);
        margin: 12px 0 20px;
        border: 1px solid var(--cream-dark);
      }

      .celebratory-border {
        border: 3px double var(--gold);
        border-radius: 12px;
        padding: 24px;
        background: linear-gradient(135deg, rgba(201, 162, 39, 0.03) 0%, rgba(74, 103, 65, 0.03) 100%);
      }

      .info-box {
        background: var(--cream);
        border: 1px solid var(--cream-dark);
        border-left: 4px solid var(--forest);
        border-radius: 6px;
        padding: 14px 18px;
        margin-top: 20px;
        text-align: left;
      }

      .info-box p {
        color: var(--brown);
        font-size: 0.9rem;
        margin: 0;
        line-height: 1.5;
      }

      /* ==================== */
      /* RESPONSIVE           */
      /* ==================== */

      @media (max-width: 480px) {
        body {
          padding: 10px;
        }

        .content {
          padding: 24px 20px;
        }

        .header {
          padding: 20px 24px;
        }

        .header h1 {
          font-size: 1.25rem;
        }

        .avatar-large {
          width: 120px;
          height: 120px;
        }

        .welcome-title {
          font-size: 1.4rem;
        }

        .defense-frame {
          padding: 16px;
        }
      }
    </style>
  </head>
  <body>

    <div class="container">
      <div class="header">
        <h1>Oral Defense Portal</h1>
        <p>Oral Examination Portal</p>
      </div>

      <div class="content">
        <!-- Screen 1: WELCOME -->
        <div id="screen-welcome" class="screen active">
          <div class="welcome-content">
            <img
              src="https://lh3.googleusercontent.com/d/15AUwvvO1w29vg__uZLp5Q-lkqcm7jn6w"
              alt="ExaminerBot"
              class="avatar-large bot-avatar"
            >
            <h2 class="welcome-title">Welcome to the Oral Defense Portal</h2>
            <p class="welcome-intro">
              Welcome to the Oral Defense Portal. I will be conducting your oral examination today.
              Please enter and submit your essay to begin.
            </p>

            <div class="ornamental-divider">
              <span class="ornament-line"></span>
              <span class="ornament-diamond"></span>
              <span class="ornament-line"></span>
            </div>

            <button onclick="showScreen('screen-submit')" class="btn btn-primary">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
              </svg>
              Enter the Portal
            </button>
          </div>
        </div>

        <!-- Screen 2: ESSAY SUBMISSION -->
        <div id="screen-submit" class="screen">
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
            <img
              src="https://lh3.googleusercontent.com/d/15AUwvvO1w29vg__uZLp5Q-lkqcm7jn6w"
              alt="ExaminerBot"
              class="bot-avatar"
              style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--gold);"
            >
            <div>
              <h2 style="font-family: 'Merriweather', Georgia, serif; font-size: 1.1rem; color: var(--burgundy); margin: 0;">Submit Your Essay</h2>
              <p style="font-size: 0.85rem; color: var(--brown); margin: 4px 0 0 0;">Provide your name and essay text below</p>
            </div>
          </div>

          <form id="essayForm" onsubmit="handleSubmit(event)">
            <div class="form-group">
              <label for="name">Your Full Name</label>
              <input
                type="text"
                id="name"
                name="name"
                placeholder="Enter your full name"
                required
                autocomplete="name"
              >
            </div>

            <div class="form-group">
              <label for="essay">Essay Text</label>
              <textarea
                id="essay"
                name="essay"
                placeholder="Paste the complete text of your essay here..."
                required
                oninput="updateCharCount()"
              ></textarea>
              <div id="charCount" class="char-count">
                <span id="currentChars">0</span>&nbsp;/&nbsp;<span id="maxChars">15,000</span> characters
              </div>
            </div>

            <button type="submit" id="submitBtn" class="btn btn-primary">
              <span id="submitText">Submit Essay</span>
              <div id="submitSpinner" class="spinner" style="display: none;"></div>
            </button>
          </form>

          <div style="text-align: center; margin-top: 16px;">
            <a href="#" onclick="showScreen('screen-welcome'); return false;" style="color: var(--brown); font-size: 0.85rem; text-decoration: none;">
              &larr; Back to welcome
            </a>
          </div>
        </div>

        <!-- Screen 3: READY FOR DEFENSE -->
        <div id="screen-ready" class="screen">
          <div class="ready-content">
            <img
              src="https://lh3.googleusercontent.com/d/15AUwvvO1w29vg__uZLp5Q-lkqcm7jn6w"
              alt="ExaminerBot"
              class="avatar-medium bot-avatar"
            >

            <div class="summary-card">
              <h3>Submission Received</h3>
              <div class="summary-item">
                <span class="summary-label">Student:</span>
                <span class="summary-value" id="summaryName">-</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Essay:</span>
                <div class="summary-value">
                  <div class="essay-preview" id="summaryEssay">-</div>
                </div>
              </div>
            </div>

            <div class="speech-bubble">
              "Excellent! I have received your essay and have prepared my questions.
              The examination awaits. When you are ready to proceed, we shall begin."
            </div>

            <div class="checklist">
              <h4 class="checklist-title">Before you begin:</h4>
              <div class="checklist-item">
                <span class="check-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                  </svg>
                </span>
                <span>Find a quiet space with minimal background noise</span>
              </div>
              <div class="checklist-item">
                <span class="check-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                  </svg>
                </span>
                <span>Ensure your microphone is working properly</span>
              </div>
              <div class="checklist-item">
                <span class="check-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                  </svg>
                </span>
                <span>Be prepared to discuss your essay in detail</span>
              </div>
            </div>

            <button onclick="startDefense()" class="btn btn-success">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
              </svg>
              Begin Oral Defense
            </button>
          </div>
        </div>

        <!-- Screen 4: DEFENSE IN PROGRESS -->
        <div id="screen-defense" class="screen">
          <div class="defense-content">
            <div class="defense-frame">
              <div class="agent-avatar-wrapper">
                <img
                  src="https://lh3.googleusercontent.com/d/15AUwvvO1w29vg__uZLp5Q-lkqcm7jn6w"
                  alt="ExaminerBot"
                  class="agent-avatar bot-avatar"
                  id="agentAvatar"
                >
              </div>

              <div class="defense-header">
                <h2 id="defenseTitle">Begin Your Defense</h2>
                <p id="defenseSubtitle">Click the button below to start speaking with the examiner</p>
              </div>

              <div id="callTimer" class="call-timer" style="display: none;">
                <span id="timerDisplay">00:00</span>
              </div>

              <!-- Widget container - always visible on this screen -->
              <div id="widgetContainer" class="widget-wrapper"></div>

              <!-- Finish Defense button (primary mechanism for transcript fetch) -->
              <div id="finishDefenseControls" style="margin-top: 16px;">
                <button onclick="finishDefense()" id="finishDefenseBtn" class="btn btn-success">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span id="finishDefenseText">Finish Defense</span>
                  <div id="finishDefenseSpinner" class="spinner" style="display: none;"></div>
                </button>
                <p id="finishDefenseHint" style="font-size: 0.8rem; color: var(--brown); margin-top: 8px;">
                  Click when your defense conversation is complete
                </p>
              </div>

              <!-- Transcript fetch progress -->
              <div id="transcriptFetchStatus" style="display: none; margin-top: 16px;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px; color: var(--brown);">
                  <div class="spinner" style="border-color: rgba(114, 47, 55, 0.3); border-top-color: var(--burgundy);"></div>
                  <span id="fetchStatusText">Saving transcript...</span>
                </div>
              </div>

              <!-- After transcript is saved -->
              <div id="postCallControls" style="display: none;">
                <div class="call-ended-message">
                  <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="var(--forest)" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span>Defense Complete</span>
                </div>
                <button onclick="showDefenseComplete()" class="btn btn-primary" style="margin-top: 16px;">
                  Continue
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Screen 5: COMPLETE -->
        <div id="screen-complete" class="screen">
          <div class="complete-content">
            <div class="celebratory-border">
              <div class="complete-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>

              <h2>The Defense is Concluded</h2>
              <p>Your oral examination has been recorded and submitted for review.</p>

              <div class="student-name-display" id="completeDisplayName">Student Name</div>

              <div class="ornamental-divider">
                <span class="ornament-line"></span>
                <span class="ornament-diamond"></span>
                <span class="ornament-line"></span>
              </div>

              <p style="font-style: italic; color: var(--burgundy);">
                "Thank you for your time and thoughtful responses.
                May your scholarly endeavors continue to flourish."
              </p>
              <p style="font-size: 0.9rem;">— ExaminerBot</p>

              <div class="info-box">
                <p>Your instructor will review your essay and defense transcript.
                Grades will be posted according to your course schedule.
                You may now close this window.</p>
              </div>
            </div>

            <button onclick="resetPortal()" class="btn btn-secondary" style="margin-top: 20px;">
              Start New Submission
            </button>
          </div>
        </div>

      </div>
    </div>

    <script src="https://unpkg.com/@elevenlabs/convai-widget-embed@beta" async type="text/javascript"></script>

    <script>
      // Configuration (loaded from backend)
      let CONFIG = {
        agentId: "",
        maxChars: 15000,
        appTitle: "Oral Defense Portal",
        appSubtitle: "Oral Examination of Literary Works"
      };

      // State
      let currentSessionId = null;
      let studentName = null;
      let essayText = null;
      let defensePrompt = null;
      let firstMessage = null;
      let selectedQuestions = null;
      let defenseActive = false;
      let callStartTime = null;
      let timerInterval = null;
      let configLoaded = false;

      // Character count
      function updateCharCount() {
        const essay = document.getElementById('essay');
        const currentChars = document.getElementById('currentChars');
        const charCountDiv = document.getElementById('charCount');
        const count = essay.value.length;

        currentChars.textContent = count.toLocaleString();

        charCountDiv.classList.remove('warning', 'error');
        if (count > CONFIG.maxChars) {
          charCountDiv.classList.add('error');
        } else if (count > CONFIG.maxChars * 0.9) {
          charCountDiv.classList.add('warning');
        }
      }

      // Form submission
      function handleSubmit(event) {
        event.preventDefault();

        essayText = document.getElementById('essay').value;
        studentName = document.getElementById('name').value;

        // Validate length
        if (essayText.length > CONFIG.maxChars) {
          alert(`Your essay exceeds the maximum length of ${CONFIG.maxChars.toLocaleString()} characters. Please shorten it and try again.`);
          return;
        }

        // Show loading state
        const submitBtn = document.getElementById('submitBtn');
        const submitText = document.getElementById('submitText');
        const submitSpinner = document.getElementById('submitSpinner');

        submitBtn.disabled = true;
        submitText.textContent = 'Submitting...';
        submitSpinner.style.display = 'block';

        // Submit to backend
        google.script.run
          .withSuccessHandler(onSubmitSuccess)
          .withFailureHandler(onSubmitError)
          .processSubmission({ name: studentName, essay: essayText });
      }

      function onSubmitSuccess(response) {
        if (response.status === "success") {
          currentSessionId = response.sessionId;
          defensePrompt = response.defensePrompt;
          firstMessage = response.firstMessage;
          selectedQuestions = response.selectedQuestions;

          // Update summary display
          document.getElementById('summaryName').textContent = studentName;
          document.getElementById('summaryEssay').textContent = essayText.substring(0, 200) + '...';

          // Switch to ready screen
          showScreen('screen-ready');
          resetSubmitButton();
        } else {
          alert("Error: " + response.message);
          resetSubmitButton();
        }
      }

      function onSubmitError(error) {
        alert("Server error: " + error.message);
        resetSubmitButton();
      }

      function resetSubmitButton() {
        const submitBtn = document.getElementById('submitBtn');
        const submitText = document.getElementById('submitText');
        const submitSpinner = document.getElementById('submitSpinner');

        submitBtn.disabled = false;
        submitText.textContent = 'Submit Essay';
        submitSpinner.style.display = 'none';
      }

      // State for call
      let widgetElement = null;
      let callInProgress = false;

      // Start defense - go directly to defense screen with widget
      function startDefense() {
        // Validate config is loaded and agent ID is set
        if (!CONFIG.agentId) {
          alert('Configuration error: No agent ID configured. Please add "elevenlabs_agent_id" to your Config sheet.');
          return;
        }

        defenseActive = true;
        showScreen('screen-defense');
        initializeWidget();
      }

      // Initialize 11Labs widget with override-prompt containing essay and questions
      function initializeWidget() {
        const container = document.getElementById('widgetContainer');
        container.innerHTML = '';

        // Create the widget element
        widgetElement = document.createElement('elevenlabs-convai');
        widgetElement.setAttribute('agent-id', CONFIG.agentId);

        // V2: Pass the complete prompt with essay and questions via override-prompt
        widgetElement.setAttribute('override-prompt', defensePrompt);
        widgetElement.setAttribute('override-first-message', firstMessage);

        // Pass session_id as dynamic variable for webhook correlation
        widgetElement.setAttribute('dynamic-variables', JSON.stringify({
          session_id: currentSessionId,
          student_name: studentName
        }));

        // Listen for widget events
        widgetElement.addEventListener('elevenlabs-convai:call', handleCallEvent);
        widgetElement.addEventListener('elevenlabs-convai:conversation', handleCallEvent);

        container.appendChild(widgetElement);
      }

      // Show the call in progress UI
      function showCallInProgress() {
        document.getElementById('postCallControls').style.display = 'none';
        document.getElementById('defenseTitle').textContent = 'Defense in Progress';
        document.getElementById('defenseSubtitle').textContent = 'Speak clearly and answer the questions';

        // Start timer if not already running
        if (!timerInterval) {
          startCallTimer();
        }
      }

      // Show the call ended UI — triggers transcript fetch
      function showCallEnded() {
        document.getElementById('agentAvatar').classList.remove('speaking');
        // If the widget fires call-ended, trigger the same fetch flow
        if (!transcriptFetchInProgress) {
          fetchTranscriptFromServer();
        }
      }

      // Track fetch state to prevent duplicate calls
      let transcriptFetchInProgress = false;

      /**
       * "Finish Defense" button click handler
       */
      function finishDefense() {
        if (transcriptFetchInProgress) return;
        fetchTranscriptFromServer();
      }

      /**
       * Fetches transcript from server with retry logic.
       * Waits 5s initially, then retries up to 3 times at 8s intervals.
       */
      function fetchTranscriptFromServer() {
        if (transcriptFetchInProgress) return;
        transcriptFetchInProgress = true;

        // Hide button, show progress
        document.getElementById('finishDefenseControls').style.display = 'none';
        document.getElementById('transcriptFetchStatus').style.display = 'block';
        document.getElementById('fetchStatusText').textContent = 'Saving transcript...';
        document.getElementById('widgetContainer').style.display = 'none';

        stopCallTimer();

        // Wait 5 seconds for ElevenLabs to process, then attempt fetch
        setTimeout(function() {
          attemptTranscriptFetch(0);
        }, 5000);
      }

      /**
       * Attempts to fetch transcript, retrying up to 3 times
       */
      function attemptTranscriptFetch(attempt) {
        const maxAttempts = 3;
        if (attempt > 0) {
          document.getElementById('fetchStatusText').textContent =
            'Waiting for transcript... (attempt ' + (attempt + 1) + '/' + (maxAttempts + 1) + ')';
        }

        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              // Transcript saved successfully
              transcriptFetchInProgress = false;
              document.getElementById('transcriptFetchStatus').style.display = 'none';
              document.getElementById('postCallControls').style.display = 'block';
              document.getElementById('defenseTitle').textContent = 'Defense Complete';
              document.getElementById('defenseSubtitle').textContent = 'Your responses have been recorded';
            } else if (result.retryable && attempt < maxAttempts) {
              // Retry after 8 seconds
              setTimeout(function() {
                attemptTranscriptFetch(attempt + 1);
              }, 8000);
            } else {
              // Final failure — show message with continue option
              transcriptFetchInProgress = false;
              document.getElementById('transcriptFetchStatus').style.display = 'none';
              document.getElementById('postCallControls').style.display = 'block';
              document.getElementById('defenseTitle').textContent = 'Defense Complete';
              document.getElementById('defenseSubtitle').textContent =
                'Your transcript will be recovered automatically. You may close this page.';
            }
          })
          .withFailureHandler(function(error) {
            console.error('Transcript fetch error:', error);
            if (attempt < maxAttempts) {
              setTimeout(function() {
                attemptTranscriptFetch(attempt + 1);
              }, 8000);
            } else {
              transcriptFetchInProgress = false;
              document.getElementById('transcriptFetchStatus').style.display = 'none';
              document.getElementById('postCallControls').style.display = 'block';
              document.getElementById('defenseTitle').textContent = 'Defense Complete';
              document.getElementById('defenseSubtitle').textContent =
                'Your transcript will be recovered automatically. You may close this page.';
            }
          })
          .fetchAndStoreTranscript(currentSessionId);
      }

      // Handle call/conversation events from the widget
      function handleCallEvent(event) {
        console.log('Widget event:', event.type, event.detail);

        const detail = event.detail || {};

        // Detect call started
        if (detail.status === 'connected' ||
            event.type.includes('started') ||
            event.type.includes('connected')) {
          if (!callInProgress) {
            callInProgress = true;
            showCallInProgress();
          }
        }

        // Update avatar speaking state
        if (detail.isSpeaking !== undefined) {
          const avatar = document.getElementById('agentAvatar');
          if (detail.isSpeaking) {
            avatar.classList.add('speaking');
          } else {
            avatar.classList.remove('speaking');
          }
        }

        // Also check mode for speaking/listening
        if (detail.mode === 'speaking') {
          document.getElementById('agentAvatar').classList.add('speaking');
        } else if (detail.mode === 'listening') {
          document.getElementById('agentAvatar').classList.remove('speaking');
        }

        // Check for call ended status
        if (detail.status === 'ended' ||
            detail.status === 'disconnected' ||
            event.type.includes('ended') ||
            event.type.includes('disconnected')) {
          if (callInProgress || defenseActive) {
            callInProgress = false;
            stopCallTimer();
            showCallEnded();
          }
        }
      }

      function startCallTimer() {
        callStartTime = Date.now();
        document.getElementById('callTimer').style.display = 'block';

        timerInterval = setInterval(() => {
          const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
          const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
          const seconds = (elapsed % 60).toString().padStart(2, '0');
          document.getElementById('timerDisplay').textContent = `${minutes}:${seconds}`;
        }, 1000);
      }

      function stopCallTimer() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }

      // Show the defense complete screen
      function showDefenseComplete() {
        defenseActive = false;
        stopCallTimer();

        document.getElementById('completeDisplayName').textContent = studentName;

        // Clean up widget
        const container = document.getElementById('widgetContainer');
        container.innerHTML = '';
        widgetElement = null;

        showScreen('screen-complete');
      }

      // Reset portal for new submission
      function resetPortal() {
        currentSessionId = null;
        studentName = null;
        essayText = null;
        defensePrompt = null;
        firstMessage = null;
        selectedQuestions = null;
        defenseActive = false;
        callStartTime = null;
        widgetElement = null;
        callInProgress = false;
        transcriptFetchInProgress = false;

        // Reset form
        document.getElementById('essayForm').reset();
        document.getElementById('currentChars').textContent = '0';
        document.getElementById('charCount').className = 'char-count';

        // Reset defense screen state
        document.getElementById('postCallControls').style.display = 'none';
        document.getElementById('finishDefenseControls').style.display = 'block';
        document.getElementById('transcriptFetchStatus').style.display = 'none';
        document.getElementById('defenseTitle').textContent = 'Begin Your Defense';
        document.getElementById('defenseSubtitle').textContent = 'Click the button below to start speaking with the examiner';
        document.getElementById('callTimer').style.display = 'none';
        document.getElementById('widgetContainer').style.display = 'flex';
        document.getElementById('widgetContainer').innerHTML = '';

        showScreen('screen-welcome');
      }

      // Screen management
      function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(screen => {
          screen.classList.remove('active');
        });
        document.getElementById(screenId).classList.add('active');
      }

      // Load configuration from backend
      function loadConfig() {
        google.script.run
          .withSuccessHandler(function(config) {
            CONFIG = config;
            configLoaded = true;

            // Update UI with config values
            document.getElementById('maxChars').textContent = CONFIG.maxChars.toLocaleString();

            // Update title if provided
            if (CONFIG.appTitle) {
              document.querySelector('.header h1').textContent = CONFIG.appTitle;
            }
            // Hide subtitle if empty, otherwise update it
            const subtitleEl = document.querySelector('.header p');
            if (CONFIG.appSubtitle) {
              subtitleEl.textContent = CONFIG.appSubtitle;
            } else {
              subtitleEl.style.display = 'none';
            }

            // Update avatar images if custom URL provided
            if (CONFIG.avatarUrl) {
              document.querySelectorAll('.bot-avatar').forEach(function(img) {
                img.src = CONFIG.avatarUrl;
              });
            }

            console.log('Config loaded:', CONFIG);
          })
          .withFailureHandler(function(error) {
            console.error('Failed to load config:', error);
            // Use defaults already set
            document.getElementById('maxChars').textContent = CONFIG.maxChars.toLocaleString();
          })
          .getFrontendConfig();
      }

      // Initialize
      document.addEventListener('DOMContentLoaded', function() {
        // Load config from backend
        loadConfig();

        // Listen for widget events at the document level
        document.addEventListener('elevenlabs-convai:call', handleCallEvent);
        document.addEventListener('elevenlabs-convai:conversation', handleCallEvent);
      });
    </script>

  </body>
</html>
